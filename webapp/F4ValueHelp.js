sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Dialog","sap/m/DialogRenderer","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Input","sap/m/InputType","sap/m/DatePicker","sap/m/HBox","sap/m/RadioButton","sap/m/TimePicker","sap/m/Button","sap/m/NavContainer","sap/m/Page","sap/m/TabContainer","sap/m/TabContainerItem","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/ListMode","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,a,n,i,r,s,l,o,d,p,u,h,c,g,m,f,v,b,y,_,T,S){"use strict";return t.extend("control.F4ValueHelp",{metadata:{properties:{title:{type:"string",defaultValue:"Suchhilfe"},serviceModel:{type:"object"},modelPaths:{type:"string[]"},contentHeight:{type:"sap.ui.core.CSSSize",defaultValue:"50%"},contentWidth:{type:"sap.ui.core.CSSSize",defaultValue:"50%"},resizable:{type:"Boolean",defaultValue:true},draggable:{type:"Boolean",defaultValue:false},showHeader:{type:"Boolean",defaultValue:false}}},_helpModel:{},_navContainer:undefined,_tabContainer:undefined,_tablePage:undefined,_tablePageTable:undefined,_selectedKeys:{},init:function(){this.attachAfterClose(this.afterClose);this.setTitle(this.getTitle());this.setStretch(sap.ui.Device.system.phone);this.addButton(new u({text:"Suche starten",press:function(){this.navigate()}.bind(this)}));this.addButton(new u({text:"Schließen",press:function(){this.close()}.bind(this)}));t.prototype.init.apply(this,arguments)},renderer:{},onBeforeRendering:function(){if(!this.getServiceModel()){jQuery.sap.log.error("Uncaught ReferenceError: serviceModel is not defined");return}try{var e=new h;this.removeStyleClass("sapUiPopupWithPadding");var a=new c({showHeader:false,showSubHeader:false,showFooter:false});this._createTabBar();a.addContent(this._tabContainer);this._tablePage=new c({showSubHeader:false,showFooter:false});this._tablePageTable=new f({mode:y.SingleSelectMaster,select:this.onTableSelect.bind(this),growing:true,growingScrollToLoad:true});this._tablePage.addContent(this._tablePageTable);e.addPage(a);e.addPage(this._tablePage);e.setInitialPage(a.getId());this.addContent(e);this._navContainer=e;t.prototype.onBeforeRendering.apply(this,arguments)}catch(e){jQuery.sap.log.error(e);if(this._tabContainer&&this._tabContainer.getItems()){this._tabContainer.destroyItems()}}},onAfterRendering:function(){if(this.getServiceModel()){this._tabContainer.$().removeClass("sapContrastPlus")}t.prototype.onAfterRendering.apply(this,arguments)},_createTabBar:function(){var e=this;var t=this.getServiceModel().getServiceMetadata();var a=t.dataServices.schema[0];this._tabContainer=new g;this._tabContainer.addStyleClass("sapUiResponsiveContentPadding");this.getModelPaths().forEach(function(t){var r=a.entityType.find(function(e){return e.name===t});var s=e._searchTitle(r,t);var l=new m({id:t,name:s});var o=new n({layout:"ResponsiveGridLayout",editable:true,labelSpanL:4,labelSpanM:4,emptySpanL:3,emptySpanM:3,columnsL:1,columnsM:1});e._helpModel[t]=r;e._helpModel[t].label=s;r.property.forEach(function(a){var n=new i({text:"{/#"+t+"/"+a.name+"/sap:label}"});o.addContent(n);var r=e._getInputForEntity(a,t);o.addContent(r)});l.addContent(o);e._tabContainer.addItem(l)});e._tabContainer.getAggregation("_tabStrip").getItems().forEach(function(e){e.getAggregation("_closeButton").setVisible(false)})},_searchTitle:function(e,t){var a;var n=e.extensions.find(function(e){return e.name==="label"});if(n){a=n.value}else{var i=this.getServiceModel().getServiceAnnotations();var r=this.getServiceModel().getServiceMetadata().dataServices.schema[0].namespace;var s=i[r+"."+t];if(s){var l=s["com.sap.vocabularies.UI.v1.HeaderInfo"];a=l?l.TypeName.String:undefined}}if(!a){a=t}return a},_getInputForEntity:function(e,t){var a=this.getInputId(e.name,t);var n;switch(e.type.split("Edm.")[1]){case"DateTime":n=new l({id:a,valueFormat:"yyyy-MM-dd",width:"10em"});break;case"Time":n=new p({id:a,valueFormat:"PTkk'H'mm'M'ss'S'",width:"10em"});break;case"Boolean":n=new o(a);n.addItem(new d({id:a+"-true",groupName:a+"-group",text:"Ja"}));n.addItem(new d({id:a+"-false",groupName:a+"-group",text:"Nein"}));n.addItem(new d({id:a+"-ignore",groupName:a+"-group",text:"Nicht berücksichtigen",selected:true}));break;default:var i=["Decimal","Double","Single","Int16","Int32","Int64","Byte","SByte"];var u=i.includes(e.type.split("Edm.")[1]);n=new r({id:a,maxLength:{parts:[{path:"/#"+t+"/"+e.name+"/@maxLength"}],formatter:this.parseToInt.bind(this)},submit:this.navigate.bind(this),type:u?s.Number:s.Text});break}return n},parseToInt:function(e){var t=parseInt(e,10);return t?t:undefined},getInputId:function(e,t){return e+"-"+t+"-ValueHelp-Input"},navigate:function(){var e=this.getButtons()[0];if(this._navContainer.getCurrentPage()===this._tablePage){e.setText("Suche starten");this._navContainer.backToTop()}else{this._prepareTable();e.setText("Zurück");this._navContainer.to(this._tablePage)}},_prepareTable:function(){var e=this;this._tablePageTable.removeAllColumns();var t=this._tabContainer.getSelectedItem();var a=new b;this._tablePage.setTitle(this._helpModel[t].label);this._helpModel[t].property.forEach(function(n,r){var s=r>1;var l=new v({demandPopin:s,minScreenWidth:s?"Small":"",header:new i({text:"{/#"+t+"/"+n.name+"/@sap:label}"})});e._tablePageTable.addColumn(l);var o=e.getTypeForDateOrTime(n);a.addCell(new i({text:{path:n.name,type:o}}))});a.data("key",this._helpModel[t].key.propertyRef);this._tablePageTable.bindItems({path:"/"+t+"Set",template:a,filters:this._getValueHelpFilters(),sorter:new S(this._helpModel[t].property[0].name)})},getTypeForDateOrTime:function(e){var t;if(e.type==="Edm.Time"){t=new sap.ui.model.odata.type.Time}else if(e.type==="Edm.DateTime"){t=new sap.ui.model.type.Date({pattern:"yyyy-MM-dd HH:mm:ss",UTC:true})}return t},_getValueHelpFilters:function(){var e=this;var t=this._helpModel[this._tabContainer.getSelectedItem()];var a=[];t.property.forEach(function(n){var i=sap.ui.getCore().byId(e.getInputId(n.name,t.name));if(i.getValue?i.getValue():i instanceof o){var r=e._getFilterOperatorAndValue(i);if(r.filterOp){a.push(new _({path:n.name,operator:r.filterOp,value1:r.value1,value2:r.value2}))}}});return a},_getFilterOperatorAndValue:function(e){var t={};if(e instanceof r){t.filterOp=e.getType()===s.Text?T.Contains:T.EQ;t.value1=e.getValue()}else if(e instanceof l){t.filterOp=T.BT;t.value1=e.getValue();t.value2=this.endOfDay(e.getDateValue())}else if(e instanceof o){var a=e.getItems();if(!a[2].getSelected()){t.filterOp=T.EQ;if(a[0].getSelected()){t.value1=true}else{t.value1=false}}}else{t.filterOp=T.EQ;t.value1=e.getValue?e.getValue():e.getSelected()}return t},endOfDay:function(e){var t=e.getTimezoneOffset()*6e4;e.setTime(e.getTime()-t);e.setDate(e.getDate()+1);e.setMilliseconds(e.getMilliseconds()-1);return e},onTableSelect:function(e){var t=this._tabContainer.getSelectedItem();var a=e.getParameters().listItem;var n={};this._helpModel[t].key.propertyRef.forEach(function(e){var t=a.getCells().find(function(t){return t.getBindingPath("text")===e.name});n[e.name]=t.getText()});this._selectedKeys=n;this.close()},getTable:function(){return this._tablePageTable},getSelectedKeys:function(){return this._selectedKeys},afterClose:function(){this.destroy()}})});